# 11 Security <!-- omit in toc -->
> [info](https://nodejs.org/en/docs/guides/security)

> [snyk best](https://snyk.io/learn/nodejs-security-best-practice/#best)

> [docker](https://snyk.io/blog/10-best-practices-to-containerize-nodejs-web-applications-with-docker/)

# 1. Logging and monitoring
> [login](./08.%20Login.md)

# 2. Auth methods
- JWT
- Bcrypt
```js
bcrypt.hashSync(input.newPass, 12)

await bcrypt.compare(input.password, pass)
```

# 3. avoid blocking the event loop
```js
const blk = async () => {
	// const find1 = wait Model.find()
  // const find2 = wait Model.find()
	// const find3 = wait Model.find()

  const find1 = Model.find({}, { title: 1, author: 1, createdAt: 1 })
  const find2 = Model.find({}, { title: 1, author: 1, createdAt: 1 })
  const find3 = Model.find({}, { title: 1, author: 1, createdAt: 1 })

  Promise.all([find1, find2, find3]).then(result => {
    console.log('result', result)
  })
}
blk()
```

# 4. Error handling
> [error handler](./03.%20Error%20Handler.md)
- pm2
- docker --restart always

# 5. Donâ€™t send unnecessary information
- GraphQL

# 6. Limit request sizes
- compression
- size
```
app.use(express.json( {size: 10mb}))
```

# 7. Validate user input
```js
  check('title').exists().withMessage('Requerido'),
```

# 8. plugins & linters
> [snyk](https://app.snyk.io/)

> [lint](https://www.npmjs.com/package/eslint-plugin-security)

# 9. audit
> [audit](./audit.md)

# 10. optional: snyk audit
```
npm install -g snyk
snyk auth
snyk container test node:16.17.0-bullseye-slim --file=Dockerfile

```

# 11. docker user
```dockerfile
RUN apk useradd node
USER node
```

# 12. npm ci
This enforces the lockfile so that inconsistencies between it and the package.json file cause an error

# 13. prod deps
```
RUN npm ci --only=production
```

# 14. prod ENV
```
ENV NODE_ENV production

```

# 15. Safely terminate Node.js Docker applications
- dumb-init:
```
RUN apt-get update && apt-get install -y --no-install-recommends dumb-init
CMD ["dumb-init", "node", "main.js"]
```

# 16. copy permission
```
COPY --chown=node:node . .
```

# 17. multi-stage builds
```dockerfile
FROM node:latest AS build
RUN apt-get update && apt-get install -y --no-install-recommends dumb-init
ARG NPM_TOKEN
WORKDIR /usr/src/app
COPY package*.json /usr/src/app/
RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
   npm ci --only=production && \
   rm -f .npmrc

__# --------------> The production image__
FROM node:16.17.0-bullseye-slim

ENV NODE_ENV production
COPY --from=build /usr/bin/dumb-init /usr/bin/dumb-init
USER node
WORKDIR /usr/src/app
COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules
COPY --chown=node:node . /usr/src/app
CMD ["dumb-init", "node", "server.js"]
```

# 18. Encriptar datos en reposo
- Crypto
